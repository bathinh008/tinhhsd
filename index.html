<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>T√≠nh H·∫°n S·ª≠ D·ª•ng Cao C·∫•p</title>

<!-- POPUP CALENDAR (Flatpickr) -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

<style>
    body {
        font-family: Arial, sans-serif;
        padding: 20px;
        max-width: 480px;
        margin: auto;
        background: #f0f3f8;
    }
    h2 {
        text-align: center;
        margin-bottom: 20px;
        font-size: 26px;
    }
    label { font-weight: bold; margin-top: 10px; display: block; }
    input {
        width: 100%;
        padding: 10px;
        margin-top: 5px;
        border-radius: 8px;
        border: 1px solid #ccc;
        font-size: 17px;
    }

    .btn-small {
        padding: 10px 14px;
        background: #8e44ad;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        margin: 8px 6px 0 0;
        font-size: 15px;
        min-width: 100px;
    }

    .btn-small.minus {
        background: #c0392b;
    }

	.btn-row {
		display: flex;
		gap: 10px;
		margin-top: 20px;
	}

	/* H√†ng ch·ª©a 2 n√∫t */
	.btn-row {
		display: flex;
		gap: 10px;
		margin-top: 20px;
	}

	/* 2 n√∫t chia ƒë·ªÅu */
	.btn-row button {
		flex: 1;
		padding: 12px;
		font-size: 17px;
		border: none;
		border-radius: 8px;
		cursor: pointer;
	}

	/* N√∫t t√≠nh to√°n */
	.main-btn {
		background: #3498db;
		color: white;
	}

	.main-btn:hover {
		background: #217dbb;
	}

	/* N√∫t l√†m m·ªõi */
	.refresh-btn {
		background: #7f8c8d;
		color: white;
	}

	.refresh-btn:hover {
		background: #636e72;
	}

    /* Accordion Box */
    .acc-header {
        background: #dfe6e9;
        padding: 12px;
        border-radius: 8px;
        margin-top: 15px;
        font-weight: bold;
        cursor: pointer;
        user-select: none;
        display: flex;
        align-items: center;
        font-size: 16px;
    }

    .acc-header:hover {
        background: #b2bec3;
    }

    .acc-header .arrow {
        font-size: 18px;
        margin-right: 10px;
        transition: transform 0.25s ease;
    }

    .acc-header.open .arrow {
        transform: rotate(90deg);
    }

    .acc-body {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.35s ease;
        padding-left: 4px;
    }

    .acc-body-inner {
        padding: 8px 0 5px 10px;
    }

    /* Result + history */
    .result-box {
        background: white;
        border-radius: 12px;
        padding: 20px;
        margin-top: 20px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .progress-bar {
        width: 100%;
        height: 20px;
        background: #e0e0e0;
        border-radius: 10px;
        overflow: hidden;
        margin: 10px 0 15px 0;
    }

    .progress-fill {
        height: 100%;
        background: #27ae60;
        width: 0%;
        transition: width 0.4s ease;
    }

    .danger { color: red; font-weight: bold; }
    .warning { color: #e67e22; font-weight: bold; }
    .good { color: #27ae60; font-weight: bold; }

    .history-box {
        background: white;
        border-radius: 10px;
        padding: 12px;
        margin-top: 20px;
        font-size: 15px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
</style>
</head>

<body>

<h2>üßÆ T√≠nh H·∫°n S·ª≠ D·ª•ng</h2>

<label>Ng√†y s·∫£n xu·∫•t (MFG)</label>
<input id="mfg" placeholder="dd/mm/yyyy" inputmode="numeric">


<!-- ====================================== -->
<!--       ACCORDION: C·ªòNG TH√ÅNG          -->
<!-- ====================================== -->

<div class="acc-header" onclick="toggleAcc('accAdd')">
    <span class="arrow">‚ñ∏</span> C·ªông th√°ng HSD nhanh
</div>
<div id="accAdd" class="acc-body">
    <div class="acc-body-inner">
        <button class="btn-small" onclick="addMonths(1)">+ 1 th√°ng</button>
        <button class="btn-small" onclick="addMonths(6)">+ 6 th√°ng</button>
        <button class="btn-small" onclick="addMonths(12)">+ 1 nƒÉm</button>
    </div>
</div>


<!-- ====================================== -->
<!--       ACCORDION: TR·ª™ TH√ÅNG           -->
<!-- ====================================== -->

<div class="acc-header" onclick="toggleAcc('accMinus')">
    <span class="arrow">‚ñ∏</span> Tr·ª´ th√°ng HSD nhanh
</div>
<div id="accMinus" class="acc-body">
    <div class="acc-body-inner">
        <button class="btn-small minus" onclick="addMonths(-1)">‚àí 1 th√°ng</button>
        <button class="btn-small minus" onclick="addMonths(-6)">‚àí 6 th√°ng</button>
        <button class="btn-small minus" onclick="addMonths(-12)">‚àí 1 nƒÉm</button>
    </div>
</div>


<label>H·∫°n s·ª≠ d·ª•ng (EXP)</label>
<input id="exp" placeholder="dd/mm/yyyy" inputmode="numeric">



<!-- N√öT T√çNH + L√ÄM M·ªöI -->
<div class="btn-row">
    <button class="main-btn" onclick="calc()">T√≠nh To√°n</button>
    <button class="refresh-btn" onclick="resetAll()">L√†m m·ªõi</button>
</div>

<div id="result"></div>

<h3>L·ªãch s·ª≠ g·∫ßn ƒë√¢y:</h3>
<div id="history" class="history-box"></div>


<script>
/* ---------- Popup l·ªãch ---------- */
const fpMFG = flatpickr("#mfg", {
    dateFormat: "d/m/Y",
    allowInput: true
});

const fpEXP = flatpickr("#exp", {
    dateFormat: "d/m/Y",
    allowInput: true
});


/* ---------- ACCORDION ---------- */
function toggleAcc(id) {
    const body = document.getElementById(id);
    const header = body.previousElementSibling;

    if (body.style.maxHeight) {
        body.style.maxHeight = null;
        header.classList.remove("open");
    } else {
        body.style.maxHeight = body.scrollHeight + "px";
        header.classList.add("open");
    }
}


/* ---------- X·ª≠ l√Ω ng√†y ---------- */
function parseDMY(str) {
    const [d, m, y] = str.split("/");
    return new Date(y, m - 1, d);
}

function formatDate(d) {
    let day = String(d.getDate()).padStart(2, "0");
    let month = String(d.getMonth() + 1).padStart(2, "0");
    let year = d.getFullYear();
    return `${day}/${month}/${year}`;
}


/* ---------- C·ªông / Tr·ª´ th√°ng ---------- */
function addMonths(monthToAdd) {
    let mfg = document.getElementById("mfg").value;
    let exp = document.getElementById("exp").value;

    if (!mfg) {
        alert("Vui l√≤ng nh·∫≠p ng√†y s·∫£n xu·∫•t tr∆∞·ªõc!");
        return;
    }

    let baseDate = exp ? parseDMY(exp) : parseDMY(mfg);

    baseDate.setMonth(baseDate.getMonth() + monthToAdd);

    let maxDate = parseDMY(mfg);
    maxDate.setFullYear(maxDate.getFullYear() + 20);

    let minDate = parseDMY(mfg);

    if (baseDate > maxDate) {
        alert("‚ö† Gi·ªõi h·∫°n t·ªëi ƒëa l√† 20 nƒÉm k·ªÉ t·ª´ ng√†y s·∫£n xu·∫•t!");
        baseDate = maxDate;
    }

    if (baseDate < minDate) {
        alert("‚ö† Kh√¥ng th·ªÉ nh·ªè h∆°n ng√†y s·∫£n xu·∫•t!");
        baseDate = minDate;
    }

    fpEXP.setDate(baseDate, true);
}


/* ---------- L∆∞u l·ªãch s·ª≠ ---------- */
function saveHistory(mfg, exp, text) {
    let list = JSON.parse(localStorage.getItem("HSD_HISTORY") || "[]");

    list.unshift({ mfg, exp, text, time: new Date().toLocaleString("vi-VN") });

    if (list.length > 10) list.pop();

    localStorage.setItem("HSD_HISTORY", JSON.stringify(list));

    renderHistory();
}

function renderHistory() {
    let box = document.getElementById("history");
    let list = JSON.parse(localStorage.getItem("HSD_HISTORY") || "[]");

    box.innerHTML = list
        .map(x => `
            <div style="margin-bottom:6px;">
                <b>${x.mfg}</b> ‚Üí <b>${x.exp}</b><br>
                <i>${x.text}</i> <br>
                <small>${x.time}</small>
                <hr>
            </div>
        `)
        .join("");
}

renderHistory();


/* ---------- T√≠nh HSD ---------- */
function calc() {
    let mfg = document.getElementById("mfg").value;
    let exp = document.getElementById("exp").value;

    if (!mfg || !exp) {
        alert("Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß ng√†y!");
        return;
    }

    const mfgDate = parseDMY(mfg);
    const expDate = parseDMY(exp);
    const today = new Date();

    let total = expDate - mfgDate;
    let used = today - mfgDate;

    if (today < mfgDate) {
        document.getElementById("result").innerHTML =
            `<div class='result-box warning'>‚ùó S·∫£n ph·∫©m ch∆∞a t·ªõi ng√†y s·∫£n xu·∫•t!</div>`;
        return;
    }

    if (today > expDate) {
        document.getElementById("result").innerHTML =
            `<div class='result-box danger'>‚ùå ƒê√É H·∫æT H·∫†N!</div>`;
        return;
    }

    let percentUsed = (used / total) * 100;
    let percentLeft = 100 - percentUsed;

    percentUsed = percentUsed.toFixed(2);
    percentLeft = percentLeft.toFixed(2);

    const daysLeft = Math.ceil((expDate - today) / (1000 * 3600 * 24));

    let emoji = "üü¢";
    let cls = "good";
    let msg = "C√≤n h·∫°n s·ª≠ d·ª•ng t·ªët";

    if (percentLeft < 30) {
        emoji = "üî¥"; cls = "danger"; msg = "S·∫Øp h·∫øt h·∫°n!";
    } else if (percentLeft < 60) {
        emoji = "üü°"; cls = "warning"; msg = "H·∫°n s·ª≠ d·ª•ng trung b√¨nh";
    }

    let color = cls === "danger" ? "red" :
                cls === "warning" ? "#e67e22" :
                "#27ae60";

    document.getElementById("result").innerHTML = `
        <div class="result-box">
            <p><b>Ng√†y s·∫£n xu·∫•t:</b> ${mfg}</p>
            <p><b>H·∫°n s·ª≠ d·ª•ng:</b> ${exp}</p>
            <p><b>C√≤n l·∫°i:</b> ${daysLeft} ng√†y</p>

            <div class="progress-bar">
                <div class="progress-fill" style="width:${percentUsed}%; background:${color}"></div>
            </div>

            <p><b>% ƒë√£ d√πng:</b> ${percentUsed}%</p>
            <p><b>% c√≤n l·∫°i:</b> ${percentLeft}%</p>

            <p class="${cls}">${emoji} <b>K·∫øt lu·∫≠n:</b> ${msg}</p>
        </div>
    `;

    saveHistory(mfg, exp, msg);
}

function resetAll() {
    document.getElementById("mfg").value = "";
    document.getElementById("exp").value = "";
    
    fpMFG.clear();
    fpEXP.clear();

    document.getElementById("result").innerHTML = "";
}
</script>

</body>
</html>
